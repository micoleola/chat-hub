<!doctype html>
<html>
  <head>
  <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="style.css">
    <title>Chat-Hub</title>
  </head>
  <body>
    <div class="se-pre-con"></div>
    <div id='userWrap' class='login-block'>
      <h1>Enter username: </h1>
      <form id='usernameForm'>
        <input id="username" autocomplete="off" required/>&nbsp;<button>Submit</button>
        </form>
    </div>
    <p id='error' style='text-align: center;'></p>
    <div id='contentWrap'>
      <div id= 'chatWrap'>
        <div id='labelWrap'><p id='chatLabel'><u><b>@#general</b></u></p></div>
        <div id='msgWrap'> <ul id="chat"></ul></div>
        <div id='info'></div><div id='info_typing'></div>
        <form action="" id='send-message'>
          <input id="message" autocomplete="off" /><button>Send</button>
        </form>
      </div>
      <div id='userBox'></div> 
    </div>
    <script src="/js/jquery-min.js"></script>
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script> -->
    <script src="socket.io/socket.io.js"></script>
    <script>

    jQuery( function($) {
      var socket = io.connect();
        var $messageForm = $('#send-message');
        var $messageBox = $('#message');
        var $chat = $('#chat');
        var $contentWrap = $('#contentWrap');
        var $usernameForm = $('#usernameForm');
        var $userBox = $('#userBox');
        var $error = $('#error');
        var $usernameBox = $('#username');
        var $chatLabel = $('p#chatLabel');
        var $info = $('#info');
        var $info_typing = $('#info_typing');
        var chatLabel = '';
        var username_val = '';

      $messageBox.on('input', function() {
        var info_typing = username_val;
        socket.emit('user typing', username_val);
      });

      socket.on('display user typing', function(data) {

        $info_typing.html(data + ' is typing...')
      });
      
      $usernameForm.submit( function(e) {
        e.preventDefault();
        username_val = ($usernameBox.val()).trim();
        socket.emit('new user', username_val, function(data){
        if(data) {
          $('#userWrap').hide();
          $contentWrap.show();
          } else {
              $error.html('Username taken');
              $usernameBox.focus(function(){
                  $error.html('');
              });
            }
        });
        $usernameBox.val(''); 
      });

      socket.on('users', function(data) {
        var userList = data.users;
        var html = "<p id='#general' class='userList'>#general</p>";
        for(i = 0; i < userList.length; i++) {
                html += '<p id="' +userList[i]+ '" class="userList">'+userList[i] +'</p>'
              }               
        $userBox.html(html);  
        $info.html(data.info);
        setTimeout(clearInfo, 3000);
                           
        $('p.userList').ready(function(){
           $('p.userList').click( function(e){
        
              chatLabeltoPull = $(this).text()
              $chatLabel.html('<u><b>@' + $(this).text()  + '</b></u>');
            
              socket.emit('save myu message', {pullLabel: chatLabeltoPull, saveLabel: chatLabel}, function(data) {
                  console.log(data);
                  for(i = 0; i < data.length; i++) {
                    var chatLine = data[i].split(':');
                    var user = chatLine[0];
                    var msg = chatLine[1];
                    var html = '<b>' + user + '</b>:&nbsp;<i>' +  msg; + '</i>'
                    $chat.append($('<li>').html(html));
                 }  
              });

                $chat.empty();
                chatRepo = [];
                  }); 
                });
            });

      function clearInfo() { $info.html(''); };

      $messageForm.submit( function(e) {
        e.preventDefault();
        $chatLabel.ready(function() {
          chatLabel = $chatLabel.text().substr(1);
          });
        var html = '<b>me</b>:&nbsp;<i>' + $messageBox.val() + '</i>';
        $chat.append($('<li>').html(html));  
        
        socket.emit('send message', { msg: $messageBox.val(), label: chatLabel});  
          $messageBox.val(''); 
          $info_typing.html(''); 
      });

      socket.on('new message', function(data){
        $info_typing.html('');
        var html = '<b>' + data.user + '</b>:&nbsp;<i>' +  data.msg + '</i>';
       
        socket.emit('save message', { msg: data.msg, label: data.user});
        $chatLabel.ready(function() {
          chatLabel = $chatLabel.text().substr(1);          
        }); 
        if (chatLabel == '#general')
          {
            $chat.append($('<li>').html(html));                  
          }    
       });

      socket.on('private message', function(data){
        $info_typing.html('');
        var html = '<b>' + data.user + '</b>:&nbsp;<i>' +  data.msg + '</i>';     
        $chatLabel.ready(function() {
          chatLabel = $chatLabel.text().substr(1);

          socket.emit('save message', { msg: data.msg, user: data.user, label: chatLabel});
          if (chatLabel == data.user)
            {
              $chat.append($('<li>').html(html));
            }                
        });     
      });
    });     
    </script>
  </body>
</html>
